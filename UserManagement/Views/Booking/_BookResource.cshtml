@model UserManagement.ViewModels.BookingViewModel

<form  id="bookResourceForm"  enctype="multipart/form-data">
    @Html.AntiForgeryToken()
    <input type="number" asp-for="UserId" hidden>
    <div class="row">
        <div class="col form-floating me-2">
            <select class="form-select" asp-for="ResourceId" aria-label="Select Role">
                <option value="" selected>Select Resource</option>
                @foreach (var resource in Model.Resources)
                {
                    if (resource.Quantity > 0) 
                    {
                        <option value="@resource.Id" data-qty="@resource.Quantity">
                            @resource.Name (Qty: @resource.Quantity)
                        </option>   
                    }
                }
            </select>   
            <label class="ms-2">Resource*</label>
            <span asp-validation-for="ResourceId" class="text-danger"></span>
        </div>
        <div class="col form-floating mb-3 me-2">
            <input type="number" class="form-control" id="Quantity" asp-for="Quantity">
            <label for="Quantity" class="ms-2">Quantity*</label>
            <span class="text-danger" asp-validation-for="Quantity"></span>
        </div>
    </div>  
    <div class="row mb-2">
       <div class="col form-floating me-2 mb-2">
            <input type="date" class="form-control" id="fromDate" style="font-size: initial;" value="dd-mm-yyyy" placeholder="dd-mm-yyyy" asp-for="FromDate">
            <label for="fromDate" style="font-size: initial;" class="ms-2">From Date</label>
            <span class="text-danger" asp-validation-for="FromDate"></span>
        </div>   
        <div class="col form-floating me-2 mb-2">
            <input type="date" class="form-control" id="toDate" style="font-size: initial;" value="dd-mm-yyyy" placeholder="dd-mm-yyyy" asp-for="ToDate">
            <label for="toDate" style="font-size: initial;" class="ms-2">To Date</label>
            <span class="text-danger" asp-validation-for="ToDate"></span>
        </div>
    </div>  
    
    <div class="modal-footer">
        <button type="submit" class="btn btn-primary" >Save</button>
        <button type="button" class="btn btn-outline-primary" data-bs-dismiss="modal" aria-label="Close">Cancel</button>
    </div>
</form>

<script>
    $(document).ready(function () { 
        var today = new Date().toISOString().split('T')[0];  
    
        $('#fromDate').attr('min', today);
        $('#toDate').attr('min', today);

        //book resource postmethod 
        $('#bookResourceForm').on('submit', function (e) {
            e.preventDefault();  

            var form = $("#bookResourceForm");

            if(form.valid()) {

                var selectedOption = $('#bookResourceForm select option:selected');
                var availableQuantity = parseInt(selectedOption.data('qty'));
                var enteredQuantity = parseInt($('#Quantity').val());

                if (enteredQuantity > availableQuantity) {
                    toastr.warning("Quantity cannot be greater than available quantity (" + availableQuantity + ").");
                    return;
                }

                var fromDate = $('#fromDate').val();
                var toDate = $('#toDate').val();

                if (fromDate > toDate) {
                    toastr.warning("From Date cannot be greater than To Date.");
                    return;
                }

                var formData = $(this).serialize();  
                $.ajax({
                    url: "/Booking/BookResource",
                    type: "POST",
                    data: formData,
                    success: function (response) {
                        if(response.success){
                            const modalEl = document.getElementById('bookResourceModal');
                            const modalInstance = bootstrap.Modal.getInstance(modalEl);
                            modalInstance.hide();
                            $('.modal-backdrop').remove();
                            toastr.success(response.message);
                            loadResourceList();
                        }else{
                            toastr.error(response.message);
                        }
                        
                    },
                    error: function (xhr) {
                        toastr.error("Error booking resource");
                    }
                });
            } 
        });
    });
</script>
@{
    <partial name="_ValidationScriptsPartial"></partial>
}

